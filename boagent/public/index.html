<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">

<head>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="assets/main.css" />
    <link rel="stylesheet" href="assets/table-style.css" />
    <script type="text/javascript" src="assets/dygraph.min.js"></script>
    <script type="text/javascript" src="assets/synchronizer.js"></script>
    <script type="text/javascript" src="assets/pureknob.js"></script>
</head>

<body style="background-color: #262B30; color: white; font-family: Ubuntu,serif">

    <span id="forkongithub"><a href="https://github.com/Boavizta/boagent">Fork me on GitHub</a></span>

    <div class="scores-box">
        <div class="score-box">
            <h3>Actual intensity</h3>
            <div id="intensity"></div>
        </div>
        <div class="score-box">
            <h3>Operational Yearly impact</h3>
            <div id="operational-score"></div>
        </div>
        <div class="score-box">
            <h3>Opti-score</h3>
            <div id="server-score"></div>
        </div>
        <div class="score-box">
            <h3>Total embodied impact</h3>
            <div id="embodied-score"></div>
        </div>
        <div class="score-box">
            <h3>CPU load</h3>
            <div id="load-score"></div>
        </div>
    </div>

    <div class="box-legend">
        <h3>Server impact</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris ullamcorper at erat id condimentum. Sed volutpat ligula vestibulum dapibus ultrices. Aliquam erat volutpat. Suspendisse non diam in nulla volutpat tincidunt id nec orci. Cras eu semper nunc. Proin molestie dictum volutpat. Donec et dapibus ipsum. Integer iaculis rhoncus odio, vitae volutpat justo mollis iaculis.</p>
    </div>
    <div class="box">
        <div id="graphimpact" style="width:100%;; height:200px;"></div>
    </div>


    <div class="box-legend">
        <h3>Carbon intensity</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris ullamcorper at erat id condimentum. Sed volutpat ligula vestibulum dapibus ultrices. Aliquam erat volutpat. Suspendisse non diam in nulla volutpat tincidunt id nec orci. Cras eu semper nunc. Proin molestie dictum volutpat. Donec et dapibus ipsum. Integer iaculis rhoncus odio, vitae volutpat justo mollis iaculis.</p>
    </div>
    <div class="box">
        <div id="graphintensity" style="width:100%;height:200px;"></div>
    </div>

    <div class="box-legend">
        <h3>Server consumption</h3>
        <p>Consumption of the last 24h of the server in milliwatts</p>
    </div>
    <div class="box">
        <div id="graphconso" style="width:100%;; height:200px;"></div>
    </div>


    <div class="box-legend">
        <h3>Server load</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris ullamcorper at erat id condimentum. Sed volutpat ligula vestibulum dapibus ultrices. Aliquam erat volutpat. Suspendisse non diam in nulla volutpat tincidunt id nec orci. Cras eu semper nunc. Proin molestie dictum volutpat. Donec et dapibus ipsum. Integer iaculis rhoncus odio, vitae volutpat justo mollis iaculis.</p>
    </div>
    <div class="box">
        <div id="graphload" style="width:100%;; height:200px;"></div>
    </div>


    <div class="box-legend">
        <h3>Recommandations</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris ullamcorper at erat id condimentum. Sed volutpat ligula vestibulum dapibus ultrices. Aliquam erat volutpat. Suspendisse non diam in nulla volutpat tincidunt id nec orci. Cras eu semper nunc. Proin molestie dictum volutpat. Donec et dapibus ipsum. Integer iaculis rhoncus odio, vitae volutpat justo mollis iaculis.</p>
    </div>
    <table>
        <thead>
            <tr>
                <th></th>
                <th>Time</th>
                <th>Type</th>
                <th>Recommendation</th>
            </tr>
        <thead>
        <tbody  id="reco-table">
        </tbody>
    </table>

<script>
    var graphintensity = new Dygraph(
        document.getElementById("graphintensity"),
        "/carbon_intensity?since=now&until=1h", // path to CSV file
        {
            fillGraph: true,
            visibility: [true, false],
            underlayCallback: function(canvas, area, g) {
                function highlight_period(x_start, x_end) {
                    var canvas_left_x = g.toDomXCoord(x_start);
                    var canvas_right_x = g.toDomXCoord(x_end);
                    var canvas_width = canvas_right_x - canvas_left_x;
                    canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                }

                for (let i = 0; i < g.numRows(); i++) {
                    if (g.getValue(i, 2) === -1){
                        for (let j = i; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== -1){
                                canvas.fillStyle = "rgb(197,255,197)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                    else if (g.getValue(i, 2) === 1){
                        for (let j = i+1; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== 1){
                                canvas.fillStyle =  "rgba(255, 153, 153)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                }
            }
        });

    var graphimpact = new Dygraph(
        document.getElementById("graphimpact"),
        "/csv?data=ram_load&since=now&until=1h", // path to CSV file
        {
            fillGraph: true,
            stackedGraph: true,
            visibility: [true, false],
            underlayCallback: function(canvas, area, g) {
                function highlight_period(x_start, x_end) {
                    var canvas_left_x = g.toDomXCoord(x_start);
                    var canvas_right_x = g.toDomXCoord(x_end);
                    var canvas_width = canvas_right_x - canvas_left_x;
                    canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                }

                for (let i = 0; i < g.numRows(); i++) {
                    if (g.getValue(i, 2) === -1){
                        for (let j = i; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== -1){
                                canvas.fillStyle = "rgb(197,255,197)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                    else if (g.getValue(i, 2) === 1){
                        for (let j = i+1; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== 1){
                                canvas.fillStyle =  "rgba(255, 153, 153)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                }
            }
        });

    var graphload = new Dygraph(
        document.getElementById("graphload"),
        "/csv?data=ram_load&since=now&until=1h", // path to CSV file
        {
            fillGraph: true,
            visibility: [false, true, true, false, false, false, false, false, false, false, false],
            underlayCallback: function(canvas, area, g) {
                function highlight_period(x_start, x_end) {
                    var canvas_left_x = g.toDomXCoord(x_start);
                    var canvas_right_x = g.toDomXCoord(x_end);
                    var canvas_width = canvas_right_x - canvas_left_x;
                    canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                }

                for (let i = 0; i < g.numRows(); i++) {
                    if (g.getValue(i, 2) === -1){
                        for (let j = i; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== -1){
                                canvas.fillStyle = "rgb(197,255,197)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                    else if (g.getValue(i, 2) === 1){
                        for (let j = i+1; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== 1){
                                canvas.fillStyle =  "rgba(255, 153, 153)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                }
            }
        });

        var graphconso = new Dygraph(
        document.getElementById("graphconso"),
        "/csv?data=power&since=now&until=1h", // path to CSV file
        {
            fillGraph: true,
            visibility: [true, false],
            underlayCallback: function(canvas, area, g) {
                function highlight_period(x_start, x_end) {
                    var canvas_left_x = g.toDomXCoord(x_start);
                    var canvas_right_x = g.toDomXCoord(x_end);
                    var canvas_width = canvas_right_x - canvas_left_x;
                    canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                }

                for (let i = 0; i < g.numRows(); i++) {
                    if (g.getValue(i, 2) === -1){
                        for (let j = i; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== -1){
                                canvas.fillStyle = "rgb(197,255,197)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                    else if (g.getValue(i, 2) === 1){
                        for (let j = i+1; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== 1){
                                canvas.fillStyle =  "rgba(255, 153, 153)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                }
            }
        });

    Dygraph.synchronize([graphintensity, graphconso], {
        zoom: true,
        selection: true,
        range: false
    });

    const optiscore = pureknob.createKnob(300, 200);
    optiscore.setProperty('angleStart', -0.75 * Math.PI);
    optiscore.setProperty('angleEnd', 0.75 * Math.PI);
    optiscore.setProperty('colorFG', '#88ff88');
    optiscore.setProperty('valMin', 0);
    optiscore.setProperty('valMax', 100);
    optiscore.setProperty('readonly', true)
    optiscore.setValue(45);
    document.getElementById('server-score').appendChild(optiscore.node());

    const operationnal = pureknob.createKnob(300, 150);
    operationnal.setProperty('angleStart', -0.75 * Math.PI);
    operationnal.setProperty('angleEnd', 0.75 * Math.PI);
    operationnal.setProperty('colorFG', '#88ff88');
    operationnal.setProperty('valMin', 0);
    operationnal.setProperty('valMax', 100);
    operationnal.setProperty('readonly', true)
    operationnal.setValue(12);
    document.getElementById('operational-score').appendChild(operationnal.node());

    const embodied = pureknob.createKnob(300, 150);
    embodied.setProperty('angleStart', -0.75 * Math.PI);
    embodied.setProperty('angleEnd', 0.75 * Math.PI);
    embodied.setProperty('colorFG', '#88ff88');
    embodied.setProperty('valMin', 0);
    embodied.setProperty('valMax', 2000);
    embodied.setProperty('readonly', true)
    document.getElementById('embodied-score').appendChild(embodied.node());

    const loadscore = pureknob.createKnob(300, 150);
    loadscore.setProperty('angleStart', -0.75 * Math.PI);
    loadscore.setProperty('angleEnd', 0.75 * Math.PI);
    loadscore.setProperty('colorFG', '#88ff88');
    loadscore.setProperty('valMin', 0);
    loadscore.setProperty('valMax', 100);
    loadscore.setProperty('readonly', true)
    loadscore.setValue(67);
    document.getElementById('load-score').appendChild(loadscore.node());

    const carbonintensity = pureknob.createKnob(300, 150);
    carbonintensity.setProperty('angleStart', -0.75 * Math.PI);
    carbonintensity.setProperty('angleEnd', 0.75 * Math.PI);
    carbonintensity.setProperty('colorFG', '#88ff88');
    carbonintensity.setProperty('valMin', 0);
    carbonintensity.setProperty('valMax', 1000);
    carbonintensity.setProperty('readonly', true)
    document.getElementById('intensity').appendChild(carbonintensity.node());

    fetch("/query")
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            embodied.setValue(data.embedded_emissions.value);
        })

    fetch("/actual_intensity")
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            carbonintensity.setValue(data);
        })


</script>

<script>
    fetch("/reco")
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            console.log(data)
            loadTableData(data);
        })

    function loadTableData(items) {
        const table = document.getElementById("reco-table");
        items.forEach( item => {
            let row = table.insertRow();

            let picto = row.insertCell(0);
            picto.innerHTML = "🕝";

            let time = row.insertCell(1);
            time.innerHTML = item.date;

            let type = row.insertCell(2);
            type.innerHTML = item.type;

            let reco = row.insertCell(3);
            reco.innerHTML = "Schedule your CRON during less carbonate hours"
        });
    }
</script>


</body>
</html>

